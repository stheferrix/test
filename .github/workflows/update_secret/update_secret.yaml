name: Update Secret Value

on:
  workflow_dispatch:

jobs:
  update-secret:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install pycryptodome

      - name: Get Public Key
        id: get_public_key
        run: |
          response=$(curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -H "Accept: application/vnd.github.v3+json" https://api.github.com/repos/${{ github.repository }}/actions/secrets/public-key)
          echo "::set-output name=public_key::$(echo $response | jq -r .key)"
          echo "::set-output name=key_id::$(echo $response | jq -r .key_id)"

      
      - uses: ./.github/actions/encrypt-secret
        id: encrypt_secret
        name: Encrypt Secret
        with:
          secret_value: 'FALSE'
          public_key: ${{ steps.get_public_key.outputs.public_key }}
          key_id: ${{ steps.get_public_key.outputs.key_id }}

      - name: Update Secret
        run: |
          curl -X PUT -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -H "Accept: application/vnd.github.v3+json" https://api.github.com/repos/${{ github.repository }}/actions/secrets/TEST_SET_SECRET -d '{"encrypted_value": "${{ steps.encrypt_secret.outputs.encrypted_value }}", "key_id": "${{ steps.get_public_key.outputs.key_id }}"}'
